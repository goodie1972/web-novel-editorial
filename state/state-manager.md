# 流程状态持久化系统

本系统用于记录网文创作的流程状态，确保在突发情况下可以恢复继续。

---

## 一、为什么需要状态持久化

### 1.1 风险场景

| 风险 | 影响 | 恢复难度 |
|------|------|----------|
| **会话中断** | 对话上下文丢失 | 需要重新开始 |
| **模型超时** | 当前任务中断 | 需要重新生成 |
| **网络故障** | 无法继续对话 | 需要重新开始 |
| **Token 超限** | 上下文被截断 | 丢失历史信息 |
| **程序崩溃** | 所有状态丢失 | 需要重新开始 |
| **意外关闭** | 对话窗口关闭 | 需要重新开始 |

### 1.2 持久化价值

- **可恢复**：任何时刻中断都能从最近检查点恢复
- **可追溯**：完整记录创作过程，便于复盘
- **可审计**：所有决策都有据可查
- **可学习**：沉淀经验用于后续优化

---

## 二、检查点机制

### 2.1 检查点类型

| 类型 | 触发时机 | 保存内容 | 恢复粒度 |
|------|----------|----------|----------|
| **阶段检查点** | 每个阶段完成 | 完整状态 | 阶段级 |
| **批次检查点** | 每5章完成 | 批次状态 | 批次级 |
| **章节检查点** | 每章完成 | 章节状态 | 章节级 |
| **关键检查点** | 关键决策点 | 决策记录 | 决策级 |

### 2.2 检查点内容

每个检查点包含：

```json
{
  "checkpoint_id": "cp-20260217-001",
  "timestamp": "2026-02-17T17:35:00+08:00",
  "type": "batch",
  "stage": "章节写作",
  "progress": {
    "current_phase": "阶段五：章节写作",
    "current_batch": "批次3：第11-15章",
    "completed_chapters": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10],
    "current_chapter": 11,
    "total_chapters": 100
  },
  "files": {
    "generated": [
      "outputs/outline.md",
      "outputs/world.md",
      "outputs/characters.md",
      "outputs/skills.md",
      "outputs/chapter-plan.md",
      "outputs/chapters/chapter-001.md",
      "outputs/chapters/chapter-002.md",
      "..."
    ],
    "pending": [
      "outputs/chapters/chapter-011.md",
      "outputs/chapters/chapter-012.md",
      "..."
    ]
  },
  "decisions": [
    {
      "id": "d001",
      "stage": "全员讨论",
      "topic": "主角金手指类型",
      "decision": "选择时空系超能力",
      "reason": "用户偏好+市场差异化"
    }
  ],
  "metrics": {
    "total_tokens": 150000,
    "total_cost": 25.50,
    "pass_rate": "100%"
  },
  "next_action": {
    "role": "写手",
    "action": "撰写第11章",
    "dependencies": ["chapter-plan.md", "chapter-summary.md"]
  }
}
```

### 2.3 检查点存储

```
project/
├── state/
│   ├── current-state.md        # 当前状态快照
│   ├── checkpoints/            # 检查点目录
│   │   ├── cp-stage-001.md     # 阶段检查点
│   │   ├── cp-stage-002.md
│   │   ├── cp-batch-001.md     # 批次检查点
│   │   ├── cp-batch-002.md
│   │   ├── cp-chapter-001.md   # 章节检查点
│   │   └── ...
│   ├── decisions/              # 决策记录
│   │   └── decisions-log.md
│   └── recovery/               # 恢复指南
│       └── recovery-guide.md
```

---

## 三、状态保存规则

### 3.1 自动保存时机

| 时机 | 动作 | 保存类型 |
|------|------|----------|
| 阶段开始 | 记录阶段信息 | 状态更新 |
| 阶段完成 | 完整保存 | 阶段检查点 |
| 批次开始 | 记录批次信息 | 状态更新 |
| 批次完成 | 完整保存 | 批次检查点 |
| 章节完成 | 简要保存 | 章节检查点 |
| 关键决策 | 记录决策 | 决策记录 |
| 用户确认 | 完整保存 | 关键检查点 |
| 异常发生 | 保存现场 | 紧急检查点 |

### 3.2 保存内容清单

#### 必须保存

- [ ] 当前阶段和进度
- [ ] 已完成的章节列表
- [ ] 已生成的文件列表
- [ ] 最近5章的摘要
- [ ] 关键决策记录
- [ ] Token 使用统计
- [ ] 下一步动作

#### 可选保存

- [ ] 完整对话历史（摘要）
- [ ] 审核意见记录
- [ ] 修改历史
- [ ] 用户反馈

### 3.3 保存格式

详见 `checkpoint-template.md`

---

## 四、恢复机制

### 4.1 恢复检测

系统启动时自动检测：

```
1. 读取 state/current-state.md
2. 检查是否存在未完成任务
3. 识别中断点
4. 加载最近检查点
5. 准备恢复上下文
```

### 4.2 恢复流程

```
中断发生
    ↓
检测状态文件是否存在
    ↓ 是
读取 current-state.md
    ↓
识别中断点
    ↓
加载最近检查点
    ↓
恢复上下文：
  - 读取已完成文件
  - 读取章节摘要
  - 读取决策记录
  - 读取审核记录
    ↓
确定下一步动作
    ↓
向用户确认恢复
    ↓
继续执行
```

### 4.3 恢复确认

恢复时向用户展示：

```markdown
## 检测到未完成项目

**项目名称**：[书名]
**中断时间**：2026-02-17 17:35
**中断位置**：章节写作 - 批次3 - 第11章

**已完成内容**：
- 阶段：需求确认 ✓ 深度研究 ✓ 全员讨论 ✓ 基础设定 ✓
- 章节：第1-10章已完成
- 字数：约 25,000 字

**待完成内容**：
- 当前：第11章撰写中
- 待写：第11-100章
- 预计剩余字数：225,000 字

**恢复选项**：
1. 从第11章继续
2. 从最近的检查点重新开始
3. 查看完整状态后决定
4. 放弃该项目

请选择：
```

### 4.4 上下文恢复

恢复时需要加载的上下文：

| 内容 | 来源 | 用途 |
|------|------|------|
| 大纲 | outline.md | 确保剧情方向 |
| 世界观 | world.md | 确保设定一致 |
| 人物 | characters.md | 确保人物一致 |
| 技能 | skills.md | 确保战力体系 |
| 章节规划 | chapter-plan.md | 确保节奏 |
| 章节摘要 | chapter-summary.md | 确保前后衔接 |
| 最近章节 | chapters/*.md | 确保风格一致 |
| 决策记录 | decisions-log.md | 了解关键决策 |

---

## 五、决策记录

### 5.1 记录内容

每个关键决策记录：

```markdown
## 决策记录 #[序号]

### 基本信息
- **时间**：2026-02-17 14:30
- **阶段**：全员讨论
- **参与角色**：总编、研究员、写手、编辑

### 决策主题
[决策的主题，如：主角金手指类型选择]

### 选项
1. 选项A：[描述] - [优缺点]
2. 选项B：[描述] - [优缺点]
3. 选项C：[描述] - [优缺点]

### 决策结果
选择：选项A

### 决策理由
1. 理由一
2. 理由二
3. 理由三

### 影响范围
- [ ] 大纲调整
- [ ] 人物设定调整
- [ ] 世界观调整
- [ ] 已写章节需要修改

### 后续行动
- [ ] 行动一
- [ ] 行动二
```

### 5.2 决策类型

| 类型 | 示例 | 影响 |
|------|------|------|
| **方向决策** | 题材选择、风格确定 | 全局 |
| **设定决策** | 金手指类型、主角性格 | 中长期 |
| **情节决策** | 剧情走向、人物关系 | 局部 |
| **修改决策** | 打回处理、优化方案 | 即时 |

---

## 六、与监控系统集成

### 6.1 联动机制

```
LLM 调用完成
    ↓
监控系统记录使用量
    ↓
状态系统保存检查点
    ↓
更新 current-state.md
```

### 6.2 数据共享

| 数据 | 监控系统 | 状态系统 |
|------|----------|----------|
| Token 使用 | 记录 | 保存到检查点 |
| 成本统计 | 计算 | 保存到检查点 |
| 阶段进度 | - | 记录 |
| 异常信息 | 记录 | 保存现场 |

---

## 七、配置项

在 `settings.json` 中配置：

```json
{
  "state": {
    "enabled": true,
    "auto_save": true,
    "checkpoint_interval": {
      "stage": true,
      "batch": true,
      "chapter": true,
      "decision": true
    },
    "max_checkpoints": 50,
    "recovery_mode": "auto"
  }
}
```

---

## 八、使用指南

### 8.1 正常流程

1. 项目开始 → 创建状态文件
2. 每个关键节点 → 自动保存检查点
3. 项目完成 → 生成最终报告

### 8.2 恢复流程

1. 检测到状态文件 → 提示恢复
2. 用户确认 → 加载上下文
3. 继续执行 → 正常流程

### 8.3 手动操作

```bash
# 查看当前状态
cat state/current-state.md

# 创建手动检查点
# 告诉总编："请保存当前状态"

# 查看检查点列表
ls state/checkpoints/

# 恢复到特定检查点
# 告诉总编："请恢复到 cp-batch-002"
```

---

## 修改记录

| 日期 | 修改人 | 修改内容 |
|------|--------|----------|
| 2026-02-17 | 总编 | 创建状态持久化系统 |
