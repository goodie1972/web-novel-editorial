# LLM 使用监控系统

本系统用于监控网文编辑部各角色的 LLM 使用情况，确保资源可控、问题可追溯。

---

## 一、监控指标

### 1.1 核心指标

| 指标 | 说明 | 单位 |
|------|------|------|
| **模型名称** | 使用的 LLM 模型 | - |
| **调用次数** | 该模型的 API 调用次数 | 次 |
| **输入Token** | 累计输入 Token 数 | tokens |
| **输出Token** | 累计输出 Token 数 | tokens |
| **总Token** | 输入 + 输出 | tokens |
| **平均响应时间** | 每次调用的平均耗时 | 秒 |
| **成功率** | 成功调用占比 | % |
| **预估成本** | 基于定价计算的费用 | 元 |

### 1.2 角色维度

每个角色独立统计：

| 角色 | 模型 | 调用次数 | 输入Token | 输出Token | 总Token | 成功率 | 预估成本 |
|------|------|----------|-----------|-----------|---------|--------|----------|
| 总编 | wolfai/gpt-5.2 | 0 | 0 | 0 | 0 | - | ¥0.00 |
| 研究员 | wolfai/glm-4.7 | 0 | 0 | 0 | 0 | - | ¥0.00 |
| 写手 | wolfai/kimi-k2.5 | 0 | 0 | 0 | 0 | - | ¥0.00 |
| 编辑 | wolfai/glm-4.7 | 0 | 0 | 0 | 0 | - | ¥0.00 |

---

## 二、记录机制

### 2.1 自动记录

每次 LLM 调用后，系统自动记录：

```json
{
  "timestamp": "2026-02-17T17:35:00+08:00",
  "role": "写手",
  "model": "wolfai/kimi-k2.5",
  "action": "撰写第5章",
  "input_tokens": 12500,
  "output_tokens": 3200,
  "response_time": 12.5,
  "status": "success",
  "error": null
}
```

### 2.2 记录时机

| 时机 | 触发条件 | 记录内容 |
|------|----------|----------|
| 调用开始 | 发起 API 请求 | 角色、模型、动作、时间戳 |
| 调用结束 | 收到响应 | Token 数、响应时间、状态 |
| 调用失败 | 异常或超时 | 错误信息、重试次数 |

### 2.3 聚合周期

| 聚合级别 | 周期 | 用途 |
|----------|------|------|
| 实时 | 每次调用 | 问题排查 |
| 批次 | 每5章完成 | 批次成本核算 |
| 阶段 | 每阶段完成 | 阶段成本核算 |
| 项目 | 项目结束 | 项目总成本 |

---

## 三、使用量日志

详见 `usage-log.md`，按以下格式记录：

### 3.1 日志格式

```markdown
## [日期] 使用量日志

### 按角色统计

| 角色 | 调用 | 输入 | 输出 | 成功率 |
|------|------|------|------|--------|
| 总编 | 5 | 15000 | 3000 | 100% |
| 研究员 | 8 | 25000 | 8000 | 100% |
| 写手 | 12 | 50000 | 25000 | 100% |
| 编辑 | 10 | 30000 | 5000 | 100% |

### 当日明细

| 时间 | 角色 | 动作 | 输入 | 输出 | 状态 |
|------|------|------|------|------|------|
| 10:30 | 研究员 | 研究简报 | 3000 | 1500 | success |
| 11:00 | 写手 | 大纲设计 | 5000 | 2000 | success |
```

### 3.2 日志文件位置

```
project/
├── monitoring/
│   ├── usage-log.md          # 使用量日志
│   ├── usage-summary.md      # 汇总报告
│   └── alerts.md             # 异常告警记录
```

---

## 四、成本控制

### 4.1 预算设置

| 项目 | 预算 | 预警阈值 |
|------|------|----------|
| 单章成本 | ¥2.00 | ¥1.50 |
| 批次成本（5章） | ¥10.00 | ¥8.00 |
| 阶段成本 | ¥50.00 | ¥40.00 |
| 项目总成本 | ¥500.00 | ¥400.00 |

### 4.2 预警机制

当达到预警阈值时：

1. **黄色预警**（80%）：继续执行，记录警告
2. **橙色预警**（90%）：暂停并提示用户确认
3. **红色预警**（100%）：暂停执行，必须用户确认后继续

### 4.3 预警通知格式

```markdown
## 成本预警

**当前状态**：橙色预警（90%）

**使用情况**：
- 已使用：¥45.00
- 预算：¥50.00
- 剩余：¥5.00

**各角色消耗**：
- 总编：¥15.00（33%）
- 研究员：¥10.00（22%）
- 写手：¥15.00（33%）
- 编辑：¥5.00（11%）

**建议**：
1. 考虑切换性价比更高的模型
2. 精简提示词长度
3. 用户确认后继续
```

---

## 五、异常监控

### 5.1 监控异常类型

| 异常类型 | 判断条件 | 处理方式 |
|----------|----------|----------|
| 调用失败 | HTTP错误或超时 | 自动重试（最多3次） |
| Token超限 | 单次超过模型限制 | 拆分请求 |
| 响应异常 | 输出为空或格式错误 | 重新生成 |
| 成本异常 | 单次调用超过阈值 | 暂停并告警 |
| 频率异常 | 短时间大量调用 | 限流保护 |

### 5.2 异常记录

```markdown
## 异常记录 - [日期]

| 时间 | 角色 | 异常类型 | 详情 | 处理结果 |
|------|------|----------|------|----------|
| 14:30 | 写手 | 调用失败 | 超时 | 重试成功 |
| 15:00 | 编辑 | 响应异常 | 输出为空 | 重新生成 |
```

---

## 六、报告输出

### 6.1 批次报告（每5章）

```markdown
## 批次使用报告 - 第X-Y章

**生成时间**：2026-02-17 18:00

### Token 使用

| 角色 | 调用次数 | 输入Token | 输出Token | 总Token |
|------|----------|-----------|-----------|---------|
| 总编 | 2 | 5000 | 800 | 5800 |
| 写手 | 5 | 25000 | 12500 | 37500 |
| 编辑 | 3 | 9000 | 1500 | 10500 |

### 成本估算

| 项目 | 金额 |
|------|------|
| 本批次成本 | ¥8.50 |
| 累计成本 | ¥42.50 |
| 剩余预算 | ¥457.50 |

### 效率分析

- 平均每章成本：¥1.70
- 平均每章耗时：15分钟
- 通过率：100%（无打回）
```

### 6.2 项目总报告

项目结束时生成完整报告，包含：
- 总Token 使用量
- 总成本
- 各角色贡献比例
- 效率分析
- 优化建议

---

## 七、集成到工作流程

### 7.1 集成点

| 阶段 | 监控动作 |
|------|----------|
| 需求确认 | 初始化监控，记录项目开始 |
| 深度研究 | 记录研究员调用 |
| 全员讨论 | 记录各角色调用 |
| 基础设定 | 记录写手、编辑调用 |
| 章节写作 | 按批次记录，每5章汇总 |
| 读者反馈 | 记录研究员调用 |
| 终审交付 | 生成项目总报告 |

### 7.2 状态检查点

每次监控记录时，同时触发状态保存（见 `state/` 模块）。

---

## 八、配置项

在 `settings.json` 中配置：

```json
{
  "monitoring": {
    "enabled": true,
    "log_level": "info",
    "alert_threshold": {
      "yellow": 0.8,
      "orange": 0.9,
      "red": 1.0
    },
    "budget": {
      "per_chapter": 2.00,
      "per_batch": 10.00,
      "per_stage": 50.00,
      "total": 500.00
    },
    "retry": {
      "max_attempts": 3,
      "backoff_seconds": 5
    }
  }
}
```

---

## 修改记录

| 日期 | 修改人 | 修改内容 |
|------|--------|----------|
| 2026-02-17 | 总编 | 创建监控系统 |
